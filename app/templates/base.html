<!-- app/templates/base.html -->
{# Base template for all user-facing pages. Provides structure, nav, footer, common scripts/styles. #}
<!DOCTYPE html>
<html lang="{{ current_language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}{{ _('Compass Platform') }}{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%2302566C'/%3E%3Ctext x='16' y='22' font-size='18' text-anchor='middle' fill='%23fff' font-family='Arial, sans-serif'%3EC%3C/text%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind_output.css') }}">
    {# main.css is mostly empty after Tailwind migration, can be removed in Phase 6 if it remains so. #}
    {# <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}"> #}
    {% block head_extra %}{% endblock %}
</head>
<body class="bg-body-bg text-default-text flex flex-col min-h-screen font-sans {% block body_class %}{% endblock %}">
    {# Notification container for dynamic messages #}
    <div id="notification-container" class="toast-container"></div>

    <header>
        <nav class="bg-primary text-white shadow-md">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        {% block mobile_trigger %}
                            {% if is_multi_user %}
                            <button type="button"
                                    id="mobile-menu-button"
                                    aria-expanded="false"
                                    aria-controls="mobile-nav"
                                    class="-ml-2 mr-2 p-2 rounded-md text-gray-100 hover:text-white hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white lg:hidden flex items-center">
                                <span class="sr-only">{{ _('Open main menu') }}</span>
                                <i class="material-icons">menu</i>
                            </button>
                            {% endif %}
                        {% endblock mobile_trigger %}
                        <a href="{{ url_for('main.index') }}" class="text-xl font-semibold text-white {% block brand_logo_adjust_class %}{% endblock %}">
                            {{ _('Compass Platform') }}
                        </a>
                    </div>
                    <div class="flex items-center">
                        <div class="hidden lg:flex lg:items-center lg:space-x-4">
                            {% if is_multi_user %}
                                {% if current_user.is_authenticated %}
                                    <div class="relative" id="desktop-user-menu-container">
                                        <button type="button"
                                                class="flex items-center text-sm rounded-full text-white hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-primary-dark focus:ring-white p-1 pr-2"
                                                id="user-menu-button-desktop" aria-expanded="false" aria-haspopup="true">
                                            <span class="sr-only">{{ _('Open user menu') }}</span>
                                            <i class="material-icons mr-1">account_circle</i>
                                            {{ display_name | default(current_user.username) }}
                                            <i class="material-icons ml-1">arrow_drop_down</i>
                                        </button>
                                        <div id="user-dropdown-desktop"
                                             class="hidden absolute right-0 mt-2 w-56 origin-top-right bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none transform opacity-0 scale-95 transition-ease-out duration-100 z-50"
                                             role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button-desktop" tabindex="-1">
                                            <div class="py-1" role="none">
                                                <a href="#!" id="profileSettingsBtn" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem" tabindex="-1"><i class="material-icons tiny text-gray-500 mr-2">person_outline</i>{{ _('User Settings') }}</a>
                                                {% if current_user.role and current_user.role.allow_api_key_management %}
                                                <a href="#!" id="apiKeysBtn" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem" tabindex="-1"><i class="material-icons tiny text-gray-500 mr-2">vpn_key</i>{{ _('Manage API Keys') }}</a>
                                                {% endif %}
                                                {% if user_permissions.allow_workflows %}
                                                <a href="{{ url_for('main.manage_prompts') }}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem" tabindex="-1"><i class="material-icons tiny text-gray-500 mr-2">playlist_add_check</i>{{ _('Manage your Workflows') }}</a>
                                                {% endif %}
                                                {% set is_admin_user = current_user.role and current_user.role.access_admin_panel %}
                                                {% if is_admin_user %}
                                                <a href="{{ url_for('admin_panel.dashboard') }}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem" tabindex="-1"><i class="material-icons tiny text-gray-500 mr-2">admin_panel_settings</i>{{ _('Admin Panel') }}</a>
                                                {% endif %}
                                                {% if current_user.role and (current_user.role.allow_api_key_management or is_admin_user or user_permissions.allow_workflows) %}
                                                <div class="border-t border-gray-200 my-1" role="separator"></div>
                                                {% endif %}
                                                <a href="{{ url_for('auth.logout') }}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem" tabindex="-1"><i class="material-icons tiny text-gray-500 mr-2">exit_to_app</i>{{ _('Logout') }}</a>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    {% if request.endpoint != 'auth.login' %}
                                    <a href="{{ url_for('auth.login') }}" class="text-gray-100 hover:text-white px-3 py-2 rounded-md text-sm font-medium">{{ _('Login') }}</a>
                                    {% endif %}
                                    {% if request.endpoint != 'auth.register' %}
                                    <a href="{{ url_for('auth.register') }}" class="text-gray-100 hover:text-white px-3 py-2 rounded-md text-sm font-medium">{{ _('Register') }}</a>
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        </div>

                        {# Language Picker - visible on mobile for login/register pages #}
                        {% if not current_user.is_authenticated and request.endpoint in ['auth.login', 'auth.register'] %}
                        <div class="relative ml-3" id="language-menu-container">
                            <button type="button"
                                    class="flex items-center text-sm text-gray-100 hover:text-white px-3 py-2 rounded-md font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-primary-dark focus:ring-white"
                                    id="language-menu-button" aria-expanded="false" aria-haspopup="true">
                                <i class="material-icons mr-1 text-base">language</i>
                                {% set lang_map_short = {'en': 'EN', 'es': 'ES', 'fr': 'FR', 'nl': 'NL'} %}
                                {% set current_lang_code = session.get('language', current_language) %}
                                <span>{{ lang_map_short.get(current_lang_code, current_lang_code | upper) }}</span>
                                <i class="material-icons ml-1 text-base">arrow_drop_down</i>
                            </button>
                            <div id="language-dropdown"
                                 class="hidden absolute right-0 mt-2 w-40 origin-top-right bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none transform opacity-0 scale-95 transition-ease-out duration-100 z-50"
                                 role="menu" aria-orientation="vertical" aria-labelledby="language-menu-button" tabindex="-1">
                                <div class="py-1" role="none">
                                    {% set lang_map_full = {'en': _('English'), 'es': _('Español'), 'fr': _('Français'), 'nl': _('Nederlands')} %}
                                    {% for lang_code in config.SUPPORTED_LANGUAGES %}
                                        <a href="{{ url_for('main.set_language', lang=lang_code) }}" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" tabindex="-1">{{ lang_map_full.get(lang_code, lang_code) }}</a>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </nav>

        {% if is_multi_user %}
        {# Mobile Sidenav - Implemented with Tailwind and Vanilla JS #}
        <div id="mobile-nav"
             class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out z-50 lg:hidden"
             role="dialog" aria-modal="true" aria-labelledby="mobile-nav-title" aria-hidden="true" tabindex="-1">
            <div class="p-4">
                <div class="flex items-center justify-between mb-4 pb-2 border-b border-gray-200">
                    <h2 id="mobile-nav-title" class="text-lg font-medium text-gray-800">
                        {% if current_user.is_authenticated %}{{ display_name | default(current_user.username) }}{% else %}{{ _('Menu') }}{% endif %}
                    </h2>
                    <button type="button" id="close-mobile-nav-button" class="p-1 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary flex items-center">
                        <span class="sr-only">{{ _('Close menu') }}</span>
                        <i class="material-icons">close</i>
                    </button>
                </div>

                {% if current_user.is_authenticated %}
                    <nav class="mt-2 space-y-1">
                        <a href="#!" id="profileSettingsBtnMobile" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md text-sm font-medium">
                            <i class="material-icons mr-3 text-gray-500">person_outline</i>{{ _('User Settings') }}
                        </a>
                        {% if current_user.role and current_user.role.allow_api_key_management %}
                        <a href="#!" id="apiKeysBtnMobile" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md text-sm font-medium">
                            <i class="material-icons mr-3 text-gray-500">vpn_key</i>{{ _('Manage API Keys') }}
                        </a>
                        {% endif %}
                        {% if user_permissions.allow_workflows %}
                        <a href="{{ url_for('main.manage_prompts') }}" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md text-sm font-medium">
                            <i class="material-icons mr-3 text-gray-500">playlist_add_check</i>{{ _('Manage your Workflows') }}
                        </a>
                        {% endif %}
                        {% set is_admin_user = current_user.role and current_user.role.access_admin_panel %}
                        {% if is_admin_user %}
                        <a href="{{ url_for('admin_panel.dashboard') }}" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md text-sm font-medium">
                            <i class="material-icons mr-3 text-gray-500">admin_panel_settings</i>{{ _('Admin Panel') }}
                        </a>
                        {% endif %}
                        <div class="border-t border-gray-200 my-2"></div>
                        <a href="{{ url_for('auth.logout') }}" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md text-sm font-medium">
                            <i class="material-icons mr-3 text-gray-500">exit_to_app</i>{{ _('Logout') }}
                        </a>
                    </nav>
                {% else %}
                    <nav class="mt-2 space-y-1">
                        {% if request.endpoint != 'auth.login' %}
                        <a href="{{ url_for('auth.login') }}" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md text-sm font-medium">{{ _('Login') }}</a>
                        {% endif %}
                        {% if request.endpoint != 'auth.register' %}
                        <a href="{{ url_for('auth.register') }}" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md text-sm font-medium">{{ _('Register') }}</a>
                        {% endif %}
                    </nav>
                {% endif %}
            </div>
        </div>
        <div id="sidenav-overlay" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-40 lg:hidden transition-opacity duration-300 ease-in-out opacity-0"></div>
        {% endif %}
    </header>

    <main class="flex-grow pt-5 pb-10">
        <div class="flash-messages-wrapper">
            {% include 'layout/components/flash_messages.html' %}
        </div>

        <div class="container mx-auto sm:px-6 lg:px-8">
            {% block content %}{% endblock %}
        </div>

        {% include 'layout/modals/api_key_modal.html' %}

        {% include 'layout/modals/profile_modal.html' %}

        {% include 'layout/modals/workflow_modal.html' %}
    </main>

    <footer class="bg-gray-200 text-gray-700 text-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="text-center">
                {{ _('Compass Platform App') }} - © {{ now.year }}
            </div>
        </div>
    </footer>

    {# Removed Materialize JS Script #}
    {# <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script> #}

    {% include 'layout/scripts/base_bootstrap.html' %}

    {% block scripts %}
        {# Common scripts loaded after DOMContentLoaded and global vars setup #}
        <script src="{{ url_for('static', filename='js/main_utils.js') }}"></script>
        <script src="{{ url_for('static', filename='js/localization.js') }}"></script>
        <script src="{{ url_for('static', filename='js/main_init.js') }}"></script>
        <script src="{{ url_for('static', filename='js/main_actions.js') }}"></script>
        <script src="{{ url_for('static', filename='js/history/state.js') }}"></script>
        <script src="{{ url_for('static', filename='js/history/styles.js') }}"></script>
        <script src="{{ url_for('static', filename='js/history/ui.js') }}"></script>
        <script src="{{ url_for('static', filename='js/history/render.js') }}"></script>
        <script src="{{ url_for('static', filename='js/history/actions.js') }}"></script>
        <script src="{{ url_for('static', filename='js/history/polling.js') }}"></script>
        <script src="{{ url_for('static', filename='js/history/events.js') }}"></script>
        <script src="{{ url_for('static', filename='js/main_poll.js') }}"></script>
        <script src="{{ url_for('static', filename='js/workflow_modal.js') }}"></script>
        <script src="{{ url_for('static', filename='js/workflow_polling.js') }}"></script>
        <script src="{{ url_for('static', filename='js/workflow_results.js') }}"></script>
        
        {% if is_multi_user %}
            {% if current_user.is_authenticated and current_user.role and current_user.role.allow_api_key_management %}
                <script src="{{ url_for('static', filename='js/user_settings.js') }}"></script>
            {% endif %}
            {% if current_user.is_authenticated %}
                <script src="{{ url_for('static', filename='js/profile.js') }}"></script>
            {% endif %}
        {% endif %}
        
        {# Page-specific scripts should come after common scripts #}
        {% block page_scripts %}{% endblock %}
        
        {# Admin-specific scripts, which might depend on common/page scripts #}
        {% block admin_scripts %}{% endblock %}
    {% endblock %}
</body>
</html>
