<!-- app/templates/admin/user_details.html -->
{% extends "admin/base_admin.html" %}

{% block subtitle %}User Details: {{ user_details.username | e }}{% endblock %}

{% block admin_head_extra %}
{# Custom styles for hidden-row and hidden-tag are now applied directly with Tailwind utilities #}
{# Styles for workflow history table cells are now applied directly with Tailwind utilities #}
{% endblock %}

{% block admin_content %}
    <a href="{{ url_for('admin_panel.manage_users') }}" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary mb-6"> {# Increased mb-4 to mb-6 #}
        <i class="material-icons left tiny -ml-0.5 mr-1.5">arrow_back</i>Back to User List
    </a>

    {# User Information Card #}
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">User Information</h2> {# Changed h6 to h2 for better semantics #}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
                <p><strong class="font-medium text-gray-600">ID:</strong> {{ user_details.id }}</p>
                <p><strong class="font-medium text-gray-600">Username:</strong> {{ user_details.username | e }}</p>
            </div>
            <div>
                <p><strong class="font-medium text-gray-600">Email:</strong> {{ user_details.email | e }}</p>
                <p><strong class="font-medium text-gray-600">Role:</strong> {{ user_details.role.name | e }}</p>
                <p><strong class="font-medium text-gray-600">Account Created:</strong> <time datetime="{{ user_details.created_at | datetime_tz }}">{{ user_details.created_at | datetime_tz }}</time></p>
            </div>
        </div>
    </div>

    {# Usage Statistics Card #}
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Usage Statistics</h2>
        {% if user_details.usage_metrics and not user_details.usage_metrics.error %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 data-table">
                    <thead class="bg-gray-50 hidden sm:table-header-group">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metric</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Last 24h</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Last 7d</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Last 30d</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">All Time</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% set metrics = user_details.usage_metrics %}
                        {% set periods = ['24h', '7d', '30d', 'all'] %}
                        
                        {# Costs Row #}
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Metric" class="px-4 py-3 text-sm text-gray-900 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Costs</td>
                            {% for period in periods %}
                                <td data-label="Last 24h" class="format-number px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none" data-value="{{ metrics.costs.get(period, 0.0)|raw_number }}" data-format="cost">{{ metrics.costs.get(period, 0.0) }}</td>
                            {% endfor %}
                        </tr>

                        {# Transcriptions Row #}
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Metric" class="px-4 py-3 text-sm text-gray-900 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Transcriptions (#)</td>
                            {% for period in periods %}
                                <td data-label="Last 24h" class="format-number px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none" data-value="{{ metrics.transcriptions.get(period, 0)|raw_number }}" data-format="integer">{{ metrics.transcriptions.get(period, 0) }}</td>
                            {% endfor %}
                        </tr>

                        {# Title Generations Row #}
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Metric" class="px-4 py-3 text-sm text-gray-900 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Title Generations (#)</td>
                            {% for period in periods %}
                                <td data-label="Last 24h" class="format-number px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none" data-value="{{ metrics.title_generations.get(period, 0)|raw_number }}" data-format="integer">{{ metrics.title_generations.get(period, 0) }}</td>
                            {% endfor %}
                        </tr>

                        {# Workflows Row #}
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Metric" class="px-4 py-3 text-sm text-gray-900 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Workflows (#)</td>
                            {% for period in periods %}
                                <td data-label="Last 24h" class="format-number px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none" data-value="{{ metrics.workflows.get(period, 0)|raw_number }}" data-format="integer">{{ metrics.workflows.get(period, 0) }}</td>
                            {% endfor %}
                        </tr>

                        {# Audio Processed Row #}
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Metric" class="px-4 py-3 text-sm text-gray-900 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Audio Processed (min)</td>
                            {% for period in periods %}
                                <td data-label="Last 24h" class="format-number px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none" data-value="{{ metrics.audio_processed.get(period, 0.0)|raw_number }}" data-format="decimal">{{ "%.2f"|format(metrics.audio_processed.get(period, 0.0)) }}</td>
                            {% endfor %}
                        </tr>

                        {# Errors Row #}
                        <tr class="block sm:table-row">
                            <td data-label="Metric" class="px-4 py-3 text-sm text-gray-900 block sm:table-cell text-right sm:text-left relative">Errors (#)</td>
                            {% for period in periods %}
                                <td data-label="Last 24h" class="format-number px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative" data-value="{{ metrics.errors.get(period, 0)|raw_number }}" data-format="integer">{{ metrics.errors.get(period, 0) }}</td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        {% elif user_details.usage_metrics.error %}
            <p class="text-red-500 text-sm">Could not load usage statistics: {{ user_details.usage_metrics.error }}</p>
        {% else %}
            <p class="text-gray-500">No usage statistics available for this user.</p>
        {% endif %}
    </div>

    {# Usage vs Quotas Card #}
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Usage vs. Quotas</h2>
        {% if usage_stats and user_details.role %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 data-table">
                    <thead class="bg-gray-50 hidden sm:table-header-group">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metric</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Daily</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Weekly</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {# Costs Row #}
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Metric" class="px-4 py-3 text-sm text-gray-900 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Costs ($)</td>
                            <td data-label="Daily" class="px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none">
                                {{ "%.2f"|format(usage_stats.daily.cost) }} / {{ "%.2f"|format(user_details.role.limit_daily_cost) if user_details.role.limit_daily_cost > 0 else '∞' }}
                            </td>
                            <td data-label="Weekly" class="px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none">
                                {{ "%.2f"|format(usage_stats.weekly.cost) }} / {{ "%.2f"|format(user_details.role.limit_weekly_cost) if user_details.role.limit_weekly_cost > 0 else '∞' }}
                            </td>
                            <td data-label="Monthly" class="px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none">
                                {{ "%.2f"|format(usage_stats.monthly.cost) }} / {{ "%.2f"|format(user_details.role.limit_monthly_cost) if user_details.role.limit_monthly_cost > 0 else '∞' }}
                            </td>
                        </tr>
                        {# Minutes Processed Row #}
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Metric" class="px-4 py-3 text-sm text-gray-900 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Minutes Processed</td>
                            <td data-label="Daily" class="px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none">
                                {{ usage_stats.daily.minutes }} / {{ user_details.role.limit_daily_minutes if user_details.role.limit_daily_minutes > 0 else '∞' }}
                            </td>
                            <td data-label="Weekly" class="px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none">
                                {{ usage_stats.weekly.minutes }} / {{ user_details.role.limit_weekly_minutes if user_details.role.limit_weekly_minutes > 0 else '∞' }}
                            </td>
                            <td data-label="Monthly" class="px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none">
                                {{ usage_stats.monthly.minutes }} / {{ user_details.role.limit_monthly_minutes if user_details.role.limit_monthly_minutes > 0 else '∞' }}
                            </td>
                        </tr>
                        {# Workflows Row #}
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Metric" class="px-4 py-3 text-sm text-gray-900 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Workflows</td>
                            <td data-label="Daily" class="px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none">
                                {{ usage_stats.daily.workflows }} / {{ user_details.role.limit_daily_workflows if user_details.role.limit_daily_workflows > 0 else '∞' }}
                            </td>
                            <td data-label="Weekly" class="px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none">
                                {{ usage_stats.weekly.workflows }} / {{ user_details.role.limit_weekly_workflows if user_details.role.limit_weekly_workflows > 0 else '∞' }}
                            </td>
                            <td data-label="Monthly" class="px-4 py-3 text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none">
                                {{ usage_stats.monthly.workflows }} / {{ user_details.role.limit_monthly_workflows if user_details.role.limit_monthly_workflows > 0 else '∞' }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-gray-500">No usage vs. quotas data available for this user.</p>
        {% endif %}
    </div>

    {# Transcription History Card #}
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Transcription History</h2> {# Changed h6 to h2 #}
        <p class="text-xs text-gray-500 mb-2">Includes records hidden from the user until physically deleted.</p>
        {% if user_details.history %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 data-table"> {# Added data-table class for responsive stacking #}
                    <thead class="bg-gray-50 hidden sm:table-header-group">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job ID</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Filename</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">API Used</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Language</th> {# Centered header #}
                            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Duration (min)</th> {# Centered header #}
                            <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> {# Centered header #}
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hidden At</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hidden Reason</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for job in user_details.history %}
                        <tr class="{{ 'opacity-60 bg-gray-100' if job.is_hidden_from_user else '' }} block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Job ID" class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">{{ job.id[:8] }}...</td>
                            <td data-label="Filename" class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">
                                {{ job.filename | e }}
                                {% if job.is_hidden_from_user %}
                                    <span class="ml-1 text-xs font-semibold text-gray-500">(Hidden)</span>
                                {% endif %}
                            </td>
                            <td data-label="API Used" class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">{{ job.api_used | e }}</td>
                            <td data-label="Language" class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none">{{ job.detected_language | e if job.detected_language else 'N/A' }}</td> {# Centered data #}
                            <td data-label="Duration (min)" class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none" data-minutes="{{ job.audio_length_minutes }}">{{ "%.2f"|format(job.audio_length_minutes) if job.audio_length_minutes is not none else 'N/A' }}</td> {# Centered data #}
                            <td data-label="Status" class="px-4 py-3 whitespace-nowrap text-sm block sm:table-cell sm:text-center relative border-b sm:border-none"> {# Centered data #}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                           {{ 'bg-green-100 text-green-800' if job.status == 'finished' else
                                              'bg-red-100 text-red-800' if job.status == 'error' else
                                              'bg-orange-100 text-orange-800' if job.status == 'cancelled' else
                                              'bg-gray-100 text-gray-800' }}">
                                    {{ job.status | capitalize }}
                                </span>
                            </td>
                            <td data-label="Created At" class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 block sm:table-cell text-right sm:text-left relative border-b sm:border-none"><time datetime="{{ job.created_at | datetime_tz }}">{{ job.created_at | datetime_tz }}</time></td>
                            <td data-label="Hidden At" class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">{% if job.hidden_date %}<time datetime="{{ job.hidden_date | datetime_tz }}">{{ job.hidden_date | datetime_tz }}</time>{% else %}-{% endif %}</td>
                            <td data-label="Hidden Reason" class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">{{ job.hidden_reason | replace('_', ' ') | title if job.hidden_reason else '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-gray-500">This user has no transcription history.</p>
        {% endif %}
    </div>

    {# Workflow History Card #}
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Workflow History</h2> {# Changed h6 to h2 #}
        {% if user_details.workflow_history %}
             <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 data-table"> {# Added data-table class for responsive stacking #}
                    <thead class="bg-gray-50 hidden sm:table-header-group">
                        <tr>
                            <th scope="col" class="px-1.5 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job ID</th>
                            <th scope="col" class="px-1.5 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Workflow Model</th>
                            <th scope="col" class="px-1.5 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prompt</th>
                            <th scope="col" class="px-1.5 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result (Preview)</th>
                            <th scope="col" class="px-1.5 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> {# Centered header #}
                            <th scope="col" class="px-1.5 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ran At</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for job in user_details.workflow_history %}
                        <tr class="{{ 'opacity-60 bg-gray-100' if job.is_hidden_from_user else '' }} block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Job ID" class="px-1.5 py-2 whitespace-nowrap text-sm text-gray-500 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">{{ job.id[:8] }}...</td>
                            <td data-label="Workflow Model" class="px-1.5 py-2 whitespace-nowrap text-sm text-gray-500 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">{{ job.workflow_model_used | e if job.workflow_model_used else 'N/A' }}</td>
                            <td data-label="Prompt" class="px-1.5 py-2 text-sm text-gray-500 max-w-xs whitespace-normal break-words block sm:table-cell text-right sm:text-left relative border-b sm:border-none">{{ job.workflow_prompt | e | truncate(100) if job.workflow_prompt else '-' }}</td>
                            <td data-label="Result (Preview)" class="px-1.5 py-2 text-sm text-gray-500 max-w-sm whitespace-normal break-words block sm:table-cell text-right sm:text-left relative border-b sm:border-none">{{ job.workflow_result | e | truncate(150) if job.workflow_result else '-' }}</td>
                            <td data-label="Status" class="px-1.5 py-2 whitespace-nowrap text-sm block sm:table-cell sm:text-center relative border-b sm:border-none"> {# Centered data #}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                           {{ 'bg-green-100 text-green-800' if job.workflow_status == 'finished' else
                                              'bg-red-100 text-red-800' if job.workflow_status == 'error' else
                                              'bg-blue-100 text-blue-800' if job.workflow_status == 'processing' else
                                              'bg-gray-100 text-gray-800' }}">
                                    {{ job.workflow_status | capitalize }}
                                </span>
                                {% if job.workflow_status == 'error' %}
                                    <i class="material-icons tiny text-red-500 ml-1 align-middle cursor-help" title="{{ job.workflow_error | e }}">info_outline</i>
                                {% endif %}
                            </td>
                            <td data-label="Ran At" class="px-1.5 py-2 whitespace-nowrap text-sm text-gray-500 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">{% if job.workflow_ran_at %}<time datetime="{{ job.workflow_ran_at | datetime_tz }}">{{ job.workflow_ran_at | datetime_tz }}</time>{% else %}-{% endif %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-gray-500">This user has no workflow history.</p>
        {% endif %}
    </div>

{% endblock %}

{% block admin_scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}