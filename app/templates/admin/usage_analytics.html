<!-- app/templates/admin/usage_analytics.html -->
{# Template for the Usage Analytics page #}
{% extends "admin/base_admin.html" %}

{% block subtitle %}Usage Analytics{% endblock %}

{% block admin_head_extra %}
    {{ super() }}
    {# Removed custom styles for .data-table, .percentage, .card-panel h6 #}
    {# Specific styles for .analytics-table and .workflow-table are now applied with Tailwind utilities #}
{% endblock %}

{% block admin_content %}
    <section class="page-section space-y-6">
        <p class="text-sm text-gray-600">Deeper dive into how the transcription service is being utilized, focusing on volume, duration, and API choices.</p>

        {# Display error if metrics loading failed #}
        {% if metrics.get('error') %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                <i class="material-icons left tiny mr-2">warning</i>
                <strong>Warning:</strong> {{ metrics.error }} Some metrics might be unavailable.
            </div>
        {% endif %}

        {# Volume Metrics #}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {# Jobs Submitted Table #}
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-gray-700 font-semibold text-lg mb-4">Jobs Submitted</h2> {# Changed h6 to h2, added text-lg #}
            <div class="table-card overflow-x-auto mt-4">
                <table class="table-shell min-w-full divide-y divide-border-default data-table"> {# Added data-table class for responsive stacking #}
                    <thead class="bg-surface-muted hidden sm:table-header-group">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Period</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Jobs</th> {# Centered header #}
                        </tr>
                    </thead>
                    <tbody class="bg-surface divide-y divide-border-default">
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0"><td data-label="Period" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Last 24h</td><td data-label="Jobs" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative border-b sm:border-none">{{ format_number(metrics.jobs_submitted.get('24h', 0), locale=formatting_locale) }}</td></tr>
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0"><td data-label="Period" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Last 7 Days</td><td data-label="Jobs" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative border-b sm:border-none">{{ format_number(metrics.jobs_submitted.get('7d', 0), locale=formatting_locale) }}</td></tr>
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0"><td data-label="Period" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Last 30 Days</td><td data-label="Jobs" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative border-b sm:border-none">{{ format_number(metrics.jobs_submitted.get('30d', 0), locale=formatting_locale) }}</td></tr>
                        <tr class="block sm:table-row"><td data-label="Period" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative">All Time</td><td data-label="Jobs" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative">{{ format_number(metrics.jobs_submitted.get('all', 0), locale=formatting_locale) }}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        {# Minutes Processed Table #}
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-gray-700 font-semibold text-lg mb-4">Minutes Processed</h2> {# Changed h6 to h2, added text-lg #}
            <div class="table-card overflow-x-auto mt-4">
                <table class="table-shell min-w-full divide-y divide-border-default data-table"> {# Added data-table class #}
                    <thead class="bg-surface-muted hidden sm:table-header-group">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Period</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Minutes</th> {# Centered header #}
                        </tr>
                    </thead>
                    <tbody class="bg-surface divide-y divide-border-default">
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0"><td data-label="Period" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Last 24h</td><td data-label="Minutes" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative border-b sm:border-none">{{ format_number(metrics.minutes_processed.get('24h', 0.0), locale=formatting_locale) }}</td></tr>
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0"><td data-label="Period" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Last 7 Days</td><td data-label="Minutes" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative border-b sm:border-none">{{ format_number(metrics.minutes_processed.get('7d', 0.0), locale=formatting_locale) }}</td></tr>
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0"><td data-label="Period" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Last 30 Days</td><td data-label="Minutes" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative border-b sm:border-none">{{ format_number(metrics.minutes_processed.get('30d', 0.0), locale=formatting_locale) }}</td></tr>
                        <tr class="block sm:table-row"><td data-label="Period" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative">All Time</td><td data-label="Minutes" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative">{{ format_number(metrics.minutes_processed.get('all', 0.0), locale=formatting_locale) }}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        </div>
    </section>

    {# API Distribution Metrics #}
    <section class="page-section space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {# API Usage (Jobs) Table #}
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-gray-700 font-semibold text-lg mb-4">API Usage Distribution (Jobs)</h2> {# Changed h6 to h2, added text-lg #}
            <div class="table-card overflow-x-auto mt-4">
                <table class="table-shell min-w-full divide-y divide-border-default analytics-table data-table"> {# Added data-table class #}
                    <thead class="bg-surface-muted hidden sm:table-header-group">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">API</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 24h</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 7d</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 30d</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">All Time</th> {# Centered header #}
                        </tr>
                    </thead>
                    <tbody class="bg-surface divide-y divide-border-default">
                        {% set periods = ['24h', '7d', '30d', 'all'] %}
                        {% for api_name, display_name in {'gpt-4o-transcribe': 'GPT-4o', 'whisper': 'Whisper', 'assemblyai': 'AssemblyAI'}.items() %}
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="API" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">{{ display_name }}</td>
                            {% for period in periods %}
                                {% set count = metrics.api_jobs_distribution.get(period, {}).get(api_name, 0) %}
                                {% set total = metrics.jobs_submitted.get(period, 0) %}
                                {% set percentage = (count * 100 / total) if total > 0 else 0 %}
                                <td data-label="{{ period|replace('h', 'h Jobs')|replace('d', 'd Jobs')|replace('all', 'All Jobs') }}" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative border-b sm:border-none"> {# Centered data cell #}
                                    <div>{{ format_number(count, locale=formatting_locale) }}</div>
                                    <div class="text-xs text-gray-400">({{ percentage | round(method='ceil') | int }}%)</div>
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {# API Usage (Minutes) Table #}
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-gray-700 font-semibold text-lg mb-4">API Usage Distribution (Minutes)</h2> {# Changed h6 to h2, added text-lg #}
            <div class="table-card overflow-x-auto mt-4">
                <table class="table-shell min-w-full divide-y divide-border-default analytics-table data-table"> {# Added data-table class #}
                     <thead class="bg-surface-muted hidden sm:table-header-group">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">API</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 24h</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 7d</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 30d</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">All Time</th> {# Centered header #}
                        </tr>
                    </thead>
                    <tbody class="bg-surface divide-y divide-border-default">
                        {% set periods = ['24h', '7d', '30d', 'all'] %}
                        {% for api_name, display_name in {'gpt-4o-transcribe': 'GPT-4o', 'whisper': 'Whisper', 'assemblyai': 'AssemblyAI'}.items() %}
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="API" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">{{ display_name }}</td>
                            {% for period in periods %}
                                {% set minutes = metrics.api_minutes_distribution.get(period, {}).get(api_name, 0.0) %}
                                {% set total = metrics.minutes_processed.get(period, 0.0) %}
                                {% set percentage = (minutes * 100 / total) if total > 0 else 0 %}
                                <td data-label="{{ period|replace('h', 'h Mins')|replace('d', 'd Mins')|replace('all', 'All Mins') }}" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative border-b sm:border-none"> {# Centered data cell #}
                                    <div>{{ format_number(minutes, locale=formatting_locale) }}</div>
                                    <div class="text-xs text-gray-400">({{ percentage | round(method='ceil') | int }}%)</div>
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </section>

    {# Language & Feature Usage #}
    <section class="page-section space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {# Language Distribution Table #}
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-gray-700 font-semibold text-lg mb-4">Language Distribution (Top 5 + Auto)</h2> {# Changed h6 to h2, added text-lg #}
            <div class="table-card overflow-x-auto mt-4">
                <table class="table-shell min-w-full divide-y divide-border-default analytics-table data-table"> {# Added data-table class #}
                    <thead class="bg-surface-muted hidden sm:table-header-group">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Language</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 24h</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 7d</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 30d</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">All Time</th> {# Centered header #}
                        </tr>
                    </thead>
                    <tbody class="bg-surface divide-y divide-border-default">
                        {% set periods = ['24h', '7d', '30d', 'all'] %}
                        {% set all_time_langs = metrics.language_distribution.get('all', {}) %}
                        {% set sorted_langs = all_time_langs | dictsort(by='value', reverse=true) %}
                        {% set top_langs = [] %}
                        {% if 'auto' in all_time_langs %}{% set _ = top_langs.append('auto') %}{% endif %}
                        {% for lang, count in sorted_langs if lang != 'auto' and top_langs|length < 6 %}
                            {% set _ = top_langs.append(lang) %}
                        {% endfor %}

                        {% for lang_code in top_langs %}
                            {% set lang_name = supported_languages.get(lang_code, lang_code | capitalize) %}
                            <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                                <td data-label="Language" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">{{ lang_name }}</td>
                                {% for period in periods %}
                                    {% set count = metrics.language_distribution.get(period, {}).get(lang_code, 0) %}
                                    {% set total_finished = metrics.download_usage.get(period, {}).get('total_finished', 0) %} {# Using total_finished as denominator for lang distribution based on finished jobs #}
                                    {% set percentage = (count * 100 / total_finished) if total_finished > 0 else 0 %}
                                    <td data-label="{{ period|replace('h', 'h Lang')|replace('d', 'd Lang')|replace('all', 'All Lang') }}" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative border-b sm:border-none"> {# Centered data cell #}
                                        <div>{{ format_number(count, locale=formatting_locale) }}</div>
                                        <div class="text-xs text-gray-400">({{ percentage | round(method='ceil') | int }}%)</div>
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <small class="text-gray-500 text-xs block mt-2">Based on finished jobs. 'Unknown' includes jobs where language wasn't detected/recorded.</small>
        </div>

        {# Context Prompt & Download Usage Table #}
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-gray-700 font-semibold text-lg mb-4">Feature Usage (%)</h2> {# Changed h6 to h2, added text-lg #}
            <div class="table-card overflow-x-auto mt-4">
                 <table class="table-shell min-w-full divide-y divide-border-default analytics-table data-table"> {# Added data-table class #}
                    <thead class="bg-surface-muted hidden sm:table-header-group">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Feature</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 24h</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 7d</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 30d</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">All Time</th> {# Centered header #}
                        </tr>
                    </thead>
                    <tbody class="bg-surface divide-y divide-border-default">
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Feature" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Context Prompt Used</td>
                            {% for period in periods %}
                                {% set usage = metrics.context_prompt_usage.get(period, {}) %}
                                {% set percentage = (usage.get('used', 0) * 100 / usage.get('total_compatible', 0)) if usage.get('total_compatible', 0) > 0 else 0 %}
                                <td data-label="{{ period|replace('h', 'h Context')|replace('d', 'd Context')|replace('all', 'All Context') }}" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative border-b sm:border-none">{{ percentage | round(method='ceil') | int }}%</td> {# Centered data cell, only percentage #}
                            {% endfor %}
                        </tr>
                         <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Feature" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Transcript Downloaded</td>
                             {% for period in periods %}
                                {% set usage = metrics.download_usage.get(period, {}) %}
                                {% set percentage = (usage.get('downloaded', 0) * 100 / usage.get('total_finished', 0)) if usage.get('total_finished', 0) > 0 else 0 %}
                                <td data-label="{{ period|replace('h', 'h Download')|replace('d', 'd Download')|replace('all', 'All Download') }}" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative border-b sm:border-none"> {# Centered data cell #}
                                    <div>{{ percentage | round(method='ceil') | int }}%</div>
                                    <div class="text-xs text-gray-400">({{ format_number(usage.get('downloaded', 0), locale=formatting_locale) }})</div>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Feature" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Automatically Generated Titles</td>
                            {% for period in periods %}
                                {% set usage = metrics.auto_title_success.get(period, {}) %}
                                {% set count = usage.get('count', 0) %}
                                {% set total_finished = usage.get('total_finished', 0) %}
                                {% set percentage = (count * 100 / total_finished) if total_finished > 0 else 0 %}
                                <td data-label="{{ period|replace('h', 'h Titles')|replace('d', 'd Titles')|replace('all', 'All Titles') }}" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative"> {# Centered data cell #}
                                    <div>{{ percentage | round(method='ceil') | int }}%</div>
                                    <div class="text-xs text-gray-400">({{ format_number(count, locale=formatting_locale) }})</div>
                                </td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
            <small class="text-gray-500 text-xs block mt-2">Context prompt % based on compatible jobs (Whisper/GPT-4o). Download % and Title % based on finished jobs.</small>
        </div>
    </div>
    </section>

    {# Workflow Usage #}
    <section class="page-section space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="md:col-span-2 bg-white shadow-md rounded-lg p-6">
            <h2 class="text-gray-700 font-semibold text-lg mb-4">Workflow Usage</h2> {# Changed h6 to h2, added text-lg #}
            <div class="table-card overflow-x-auto mt-4">
                <table class="table-shell min-w-full divide-y divide-border-default workflow-table data-table"> {# Added data-table class #}
                    <thead class="bg-surface-muted hidden sm:table-header-group">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted uppercase tracking-wider">Model</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 24h</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 7d</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">Last 30d</th> {# Centered header #}
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">All Time</th> {# Centered header #}
                        </tr>
                    </thead>
                    <tbody class="bg-surface divide-y divide-border-default">
                        {% set periods = ['24h', '7d', '30d', 'all'] %}
                        {% for model_id, display_name in supported_workflow_models.items() %}
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                            <td data-label="Model" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">{{ display_name }}</td>
                            {% for period in periods %}
                                {% set count = metrics.workflow_model_distribution.get(period, {}).get(model_id, 0) %}
                                {% set total = metrics.workflows_run.get(period, 0) %}
                                {% set percentage = (count * 100 / total) if total > 0 else 0 %}
                                <td data-label="{{ period|replace('h', 'h WF')|replace('d', 'd WF')|replace('all', 'All WF') }}" class="px-6 py-4 text-sm text-text-muted block sm:table-cell sm:text-center relative border-b sm:border-none"> {# Centered data cell #}
                                    <div>{{ format_number(count, locale=formatting_locale) }}</div>
                                    <div class="text-xs text-gray-400">({{ percentage | round(method='ceil') | int }}%)</div>
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        <tr class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0 font-semibold">
                            <td data-label="Total" class="px-6 py-4 text-sm text-text-strong block sm:table-cell text-right sm:text-left relative border-b sm:border-none">Total Workflows Run</td>
                             {% for period in periods %}
                                <td data-label="{{ period|replace('h', 'h Total WF')|replace('d', 'd Total WF')|replace('all', 'All Total WF') }}" class="px-6 py-4 text-sm text-text-strong block sm:table-cell sm:text-center relative">{{ format_number(metrics.workflows_run.get(period, 0), locale=formatting_locale) }}</td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
            <small class="text-gray-500 text-xs block mt-2">Based on successfully finished workflows.</small>
        </div>
    </div>
    </section>

{% endblock %}

{% block admin_scripts %}
    {{ super() }}
    {# No specific JS needed for this page yet #}
{% endblock %}
