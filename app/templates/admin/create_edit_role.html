<!-- app/templates/admin/create_edit_role.html -->
{# Template for creating or editing roles #}
{% extends "admin/base_admin.html" %}
{% import "layout/components/form_layout.html" as form_layout %}
{% import "layout/components/ui_helpers.html" as ui %}

{# Set the subtitle based on the title passed from the route #}
{% block subtitle %}{{ title }}{% endblock %}

{% block admin_head_extra %}
    {{ super() }}
    {# Spinner class is now handled by Tailwind utilities in JS if needed, or directly on elements #}
{% endblock %}

{% block admin_content %}
    {% set form_intro = 'Define the details and permissions for the new role.' if 'Create' in title else 'Modify the details and permissions for this role.' %}
    {% call form_layout.card(title='Role Details', description=form_intro) %}
        <form method="POST" action="" class="space-y-8">
            {{ form.hidden_tag() }}

            {% call form_layout.section(title='Basic Role Info', divider=True) %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="{{ form.name.id }}" class="form-label">{{ form.name.label.text }}</label>
                        {{ form.name(class="input-control" + (" border-red-500" if form.name.errors else ""), required=True, autofocus=True, id=form.name.id) }}
                        {% if form.name.errors %}
                            <p class="form-error">{{ form.name.errors[0] }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.description.id }}" class="form-label">{{ form.description.label.text }}</label>
                        {{ form.description(class="input-textarea" + (" border-red-500" if form.description.errors else ""), rows="3", id=form.description.id) }}
                        {% if form.description.errors %}
                            <p class="form-error">{{ form.description.errors[0] }}</p>
                        {% endif %}
                    </div>
                </div>
            {% endcall %}

            {% call form_layout.section(
                title='Default Models',
                description='Choose default providers for users assigned to this role. Leave blank to use system defaults.',
                divider=True
            ) %}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="{{ form.default_transcription_model.id }}" class="form-label">{{ form.default_transcription_model.label.text }}</label>
                        {{ form.default_transcription_model(class="input-select" + (" border-red-500" if form.default_transcription_model.errors else ""), id=form.default_transcription_model.id) }}
                        {% if form.default_transcription_model.errors %}
                            <p class="form-error">{{ form.default_transcription_model.errors[0] }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.default_title_generation_model.id }}" class="form-label">{{ form.default_title_generation_model.label.text }}</label>
                        {{ form.default_title_generation_model(class="input-select" + (" border-red-500" if form.default_title_generation_model.errors else ""), id=form.default_title_generation_model.id) }}
                        {% if form.default_title_generation_model.errors %}
                            <p class="form-error">{{ form.default_title_generation_model.errors[0] }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.default_workflow_model.id }}" class="form-label">{{ form.default_workflow_model.label.text }}</label>
                        {{ form.default_workflow_model(class="input-select" + (" border-red-500" if form.default_workflow_model.errors else ""), id=form.default_workflow_model.id) }}
                        {% if form.default_workflow_model.errors %}
                            <p class="form-error">{{ form.default_workflow_model.errors[0] }}</p>
                        {% endif %}
                    </div>
                </div>
            {% endcall %}

            {% call form_layout.section(title='Permissions') %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4">
                    {# API Access Column #}
                    <div class="space-y-3">
                    <h4 class="section-title text-sm text-text-muted">API Access</h4>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.use_api_assemblyai(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.use_api_assemblyai.label.text }}</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.use_api_openai_whisper(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.use_api_openai_whisper.label.text }}</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.use_api_openai_gpt_4o_transcribe(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.use_api_openai_gpt_4o_transcribe.label.text }}</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.use_api_google_gemini(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.use_api_google_gemini.label.text }}</span>
                    </label>
                </div>

                {# Feature Access Column #}
                <div class="space-y-3">
                    <h4 class="section-title text-sm text-text-muted">Feature Access</h4>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.allow_large_files(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.allow_large_files.label.text }}</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.allow_context_prompt(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.allow_context_prompt.label.text }}</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.allow_download_transcript(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.allow_download_transcript.label.text }}</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.allow_workflows(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.allow_workflows.label.text }}</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.allow_speaker_diarization(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.allow_speaker_diarization.label.text }}</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.allow_auto_title_generation(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.allow_auto_title_generation.label.text }}</span>
                    </label>
                </div>

                {# Account & Admin Column #}
                <div class="space-y-3">
                    <h4 class="section-title text-sm text-text-muted">Account & Admin</h4>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.allow_api_key_management(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.allow_api_key_management.label.text }}</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.allow_public_api_access(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.allow_public_api_access.label.text }}</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.access_admin_panel(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.access_admin_panel.label.text }}</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        {{ form.manage_workflow_templates(class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary") }}
                        <span class="text-sm text-text-strong">{{ form.manage_workflow_templates.label.text }}</span>
                    </label>
                </div>
            </div>
            {% endcall %}

            {% call form_layout.section(title='Usage Limits', description='Set to 0 for unlimited.', divider=True) %}
            <div class="grid grid-cols-4 gap-x-6 gap-y-2 items-end">
                {# Headers #}
                <div class="col-start-2 text-sm font-semibold text-text-muted">Daily Quota</div>
                <div class="text-sm font-semibold text-text-muted">Weekly Quota</div>
                <div class="text-sm font-semibold text-text-muted">Monthly Quota</div>

                {# Costs Row #}
                <div class="form-label self-center">Costs ($)</div>
                <div>
                    {{ form.limit_daily_cost(type="number", min="0", step="0.01", class="input-control" + (" border-red-500" if form.limit_daily_cost.errors else "")) }}
                </div>
                <div>
                    {{ form.limit_weekly_cost(type="number", min="0", step="0.01", class="input-control" + (" border-red-500" if form.limit_weekly_cost.errors else "")) }}
                </div>
                <div>
                    {{ form.limit_monthly_cost(type="number", min="0", step="0.01", class="input-control" + (" border-red-500" if form.limit_monthly_cost.errors else "")) }}
                </div>

                {# Minutes Processed Row #}
                <div class="form-label self-center">Minutes Processed</div>
                <div>
                    {{ form.limit_daily_minutes(type="number", min="0", step="1", class="input-control" + (" border-red-500" if form.limit_daily_minutes.errors else "")) }}
                </div>
                <div>
                    {{ form.limit_weekly_minutes(type="number", min="0", step="1", class="input-control" + (" border-red-500" if form.limit_weekly_minutes.errors else "")) }}
                </div>
                <div>
                    {{ form.limit_monthly_minutes(type="number", min="0", step="1", class="input-control" + (" border-red-500" if form.limit_monthly_minutes.errors else "")) }}
                </div>

                {# Workflows Row #}
                <div class="form-label self-center">Workflows</div>
                <div>
                    {{ form.limit_daily_workflows(type="number", min="0", step="1", class="input-control" + (" border-red-500" if form.limit_daily_workflows.errors else "")) }}
                </div>
                <div>
                    {{ form.limit_weekly_workflows(type="number", min="0", step="1", class="input-control" + (" border-red-500" if form.limit_weekly_workflows.errors else "")) }}
                </div>
                <div>
                    {{ form.limit_monthly_workflows(type="number", min="0", step="1", class="input-control" + (" border-red-500" if form.limit_monthly_workflows.errors else "")) }}
                </div>
            </div>
            <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-6">
                 <div>
                    <label for="{{ form.max_history_items.id }}" class="form-label">{{ form.max_history_items.label.text }}</label>
                    {{ form.max_history_items(type="number", min="0", step="1", class="input-control" + (" border-red-500" if form.max_history_items.errors else ""), id=form.max_history_items.id) }}
                    {% if form.max_history_items.errors %}
                        <p class="form-error">{{ form.max_history_items.errors[0] }}</p>
                    {% endif %}
                </div>
                <div>
                    <label for="{{ form.history_retention_days.id }}" class="form-label">{{ form.history_retention_days.label.text }}</label>
                    {{ form.history_retention_days(type="number", min="0", step="1", class="input-control" + (" border-red-500" if form.history_retention_days.errors else ""), id=form.history_retention_days.id) }}
                    {% if form.history_retention_days.errors %}
                        <p class="form-error">{{ form.history_retention_days.errors[0] }}</p>
                    {% endif %}
                </div>
            </div>
            {% endcall %}

        {# Submit Button #}
        <div class="pt-5">
            <div class="flex justify-start gap-3">
                {{ ui.button(form.submit.label.text, variant='primary', type='submit', icon='save', icon_position='start') }}
                <a href="{{ url_for('admin_panel.manage_roles') }}" class="ui-btn ui-btn--secondary">
                    {{ _('Cancel') }}
                </a>
            </div>
        </div>
    </form>
    {% endcall %}
{% endblock %}

{% block admin_scripts %}
    {{ super() }}
    {# No specific JS needed for this page beyond base admin scripts #}
{% endblock %}
