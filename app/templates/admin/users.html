<!-- app/templates/admin/users.html -->
{# Template for managing users in the admin panel #}
{% extends "admin/base_admin.html" %}

{# Set the subtitle for this specific admin page #}
{% block subtitle %}User Management{% endblock %}

{% block admin_head_extra %}
    {# No page-specific styles needed here, Tailwind utilities and admin.js handle styling and dynamic classes. #}
{% endblock %}


{# Define the main content for the user management page #}
{% block admin_content %}
    <p class="text-sm text-gray-600 mb-6">View and manage user accounts for the application.</p>

    {# Display error if loading failed #}
    {% if error %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <i class="material-icons left tiny mr-2">warning</i>
            <strong>Error:</strong> {{ error }}
        </div>
    {% endif %}

    {# Table to display users #}
    <div class="shadow border-b border-gray-200 sm:rounded-lg overflow-x-auto mt-4">
        <table class="min-w-full divide-y divide-gray-200 data-table" id="usersTable"> {# Added data-table class for responsive stacking #}
            <thead class="bg-gray-50 hidden sm:table-header-group">
                <tr>
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th> {# Centered header #}
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Language</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Transcriptions</th> {# Centered header #}
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Workflows</th> {# Centered header #}
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Minutes Processed</th> {# Centered header #}
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                {% if users %}
                    {% for user in users %}
                    {% set is_initial_admin = (user.username == config.ADMIN_USERNAME) %}
                    <tr data-user-id="{{ user.id }}" class="block sm:table-row border-b sm:border-none mb-4 sm:mb-0">
                        <td data-label="ID" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none"> {# Centered data #}
                            {{ user.id }}
                        </td>
                        <td data-label="Username" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">
                            <a href="{{ url_for('admin_panel.user_details', user_id=user.id) }}" class="text-primary hover:text-primary-dark">{{ user.username | e }}</a>
                        </td>
                        <td data-label="Email" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">
                            {{ user.email | e }}
                        </td>
                        <td data-label="Role" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">
                            <span class="role-display cursor-pointer underline decoration-dotted hover:bg-gray-200 p-1 rounded-sm" data-role-id="{{ user.role_id }}">
                                  {{ user.role_name | e }}
                            </span>
                            <select class="role-select hidden form-select text-sm rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary w-auto" data-user-id="{{ user.id }}"
                                    {% if is_initial_admin %}disabled{% endif %}>
                                {% for role in all_roles %}
                                    <option value="{{ role.id }}" {% if role.id == user.role_id %}selected{% endif %}>
                                        {{ role.name | e }}
                                    </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td data-label="Language" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">
                            {{ user.language | e if user.language else '-' }}
                        </td>
                        <td data-label="Created At" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 block sm:table-cell text-right sm:text-left relative border-b sm:border-none">
                            <time datetime="{{ user.created_at | datetime_tz }}">{{ user.created_at | datetime_tz }}</time>
                        </td>
                        <td data-label="Total Transcriptions" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none"> {# Centered data #}
                            {{ user.total_transcriptions }}
                        </td>
                        <td data-label="Total Workflows" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none"> {# Centered data #}
                            {{ user.total_workflows }}
                        </td>
                        <td data-label="Total Minutes" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 block sm:table-cell sm:text-center relative border-b sm:border-none" data-minutes="{{ user.total_minutes }}"> {# Centered data #}
                            {{ "%.2f"|format(user.total_minutes) }}
                        </td>
                        <td data-label="Actions" class="px-6 py-4 whitespace-nowrap text-sm font-medium block sm:table-cell text-right sm:text-left relative">
                            <div class="flex items-center sm:justify-start justify-end space-x-1">
                                <button type="button"
                                        class="edit-role-btn p-1.5 rounded-full text-gray-400 hover:text-blue-600 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-transparent disabled:hover:text-gray-400"
                                        data-user-id="{{ user.id }}"
                                        title="Edit Role"
                                        {% if is_initial_admin %}disabled{% endif %}>
                                    <i class="material-icons text-base">edit</i>
                                </button>
                                <button type="button"
                                        class="delete-user-btn p-1.5 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-transparent disabled:hover:text-gray-400"
                                        data-user-id="{{ user.id }}" data-username="{{ user.username | e }}"
                                        title="Delete User"
                                        {% if is_initial_admin %}disabled{% endif %}>
                                    <i class="material-icons text-base">delete</i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% elif not error %}
                    <tr>
                        <td colspan="10" class="px-6 py-4 text-center text-gray-500">No users found.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {# Pagination Controls #}
    {% if pagination and pagination.total_pages > 1 %}
    <div class="mt-6 border-t border-gray-200 pt-4">
        <div class="flex flex-col items-center"> {# Centering container for pagination and text #}
            <nav class="relative z-0 inline-flex flex-wrap justify-center rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                <a href="{{ url_for('admin_panel.manage_users', page=pagination.current_page - 1) if pagination.current_page > 1 else '#' }}"
                   class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 {{ 'pointer-events-none opacity-50' if pagination.current_page == 1 }}">
                    <span class="sr-only">Previous</span>
                    <i class="material-icons text-sm">chevron_left</i>
                </a>
                {% set ns = namespace(prev_show_page=false) %} {# Initialize namespace for ellipsis logic #}
                {% for page_num in range(1, pagination.total_pages + 1) %}
                    {# Logic to show limited page numbers (e.g., first, last, current, and neighbors) #}
                    {% set show_page = false %}
                    {% if pagination.total_pages <= 7 %} {# Show all if 7 or less pages #}
                        {% set show_page = true %}
                    {% elif page_num == 1 or page_num == pagination.total_pages %} {# Always show first and last #}
                        {% set show_page = true %}
                    {% elif page_num >= pagination.current_page - 1 and page_num <= pagination.current_page + 1 %} {# Show current and immediate neighbors #}
                        {% set show_page = true %}
                    {% elif (pagination.current_page <= 3 and page_num <= 3) or (pagination.current_page >= pagination.total_pages - 2 and page_num >= pagination.total_pages - 2) %} {# Show first 3 or last 3 if current is near start/end #}
                         {% set show_page = true %}
                    {% endif %}

                    {% if show_page %}
                        <a href="{{ url_for('admin_panel.manage_users', page=page_num) }}"
                           aria-current="{{ 'page' if page_num == pagination.current_page else 'false' }}"
                           class="relative inline-flex items-center px-4 py-2 border text-sm font-medium
                                  {% if page_num == pagination.current_page %} z-10 bg-primary-light border-primary text-primary-dark {% else %} bg-white border-gray-300 text-gray-500 hover:bg-gray-50 {% endif %}">
                            {{ page_num }}
                        </a>
                    {% elif ns.prev_show_page and not show_page %} {# Use ns.prev_show_page #}
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>
                    {% endif %}
                    {% set ns.prev_show_page = show_page %} {# Update namespace variable #}
                {% endfor %}
                <a href="{{ url_for('admin_panel.manage_users', page=pagination.current_page + 1) if pagination.current_page < pagination.total_pages else '#' }}"
                   class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 {{ 'pointer-events-none opacity-50' if pagination.current_page == pagination.total_pages }}">
                    <span class="sr-only">Next</span>
                    <i class="material-icons text-sm">chevron_right</i>
                </a>
            </nav>
            <div class="mt-3 text-sm text-gray-600">
                Showing {{ users|length }} of {{ pagination.total_users }} users
            </div>
        </div>
    </div>
    {% elif pagination and pagination.total_users == 0 and not error %}
         {# Handled by the 'No users found' message in the table #}
    {% endif %}

{% endblock %}

{# Add page-specific JavaScript #}
{% block admin_scripts %}
    {{ super() }} {# Include scripts from base_admin.html #}
    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}