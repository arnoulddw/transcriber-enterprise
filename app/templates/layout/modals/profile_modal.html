<!-- app/templates/layout/modals/profile_modal.html -->
{# User Settings Modal (Profile Modal) - Implemented with Tailwind and Vanilla JS #}
{% if is_multi_user and current_user.is_authenticated %}
<div id="profileModal"
     class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden transition-opacity duration-300 ease-in-out opacity-0"
     role="dialog" aria-modal="true" aria-labelledby="profileModalTitle" aria-hidden="true">
    <div id="profileModalOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity duration-300 ease-in-out opacity-0"></div>
    <div id="profileModalPanel"
         class="relative bg-white rounded-lg shadow-xl transform transition-all sm:max-w-2xl sm:w-full
                max-h-[90vh] flex flex-col
                opacity-0 scale-95 duration-300 ease-out">
        <div class="flex items-start justify-between p-4 border-b border-gray-200 rounded-t">
            <h3 id="profileModalTitle" class="text-xl font-semibold text-gray-900">
                {{ _('User Settings') }}
            </h3>
            <button type="button" id="profileModalCloseButtonHeader"
                    class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center"
                    aria-label="Close modal">
                <i class="material-icons">close</i>
            </button>
        </div>
        <div class="p-6 space-y-6 overflow-y-auto">
            <form id="profileForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="profileUsername" class="block text-sm font-medium text-gray-700">{{ _('Username') }}</label>
                        <input id="profileUsername" type="text" name="username" value="{{ current_user.username }}"
                               class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                        <span id="profileUsernameError" class="text-xs text-red-600 mt-1"></span>
                    </div>
                    <div>
                        <label for="profileEmail" class="block text-sm font-medium text-gray-700">{{ _('Email') }}</label>
                        <input id="profileEmail" type="email" name="email" value="{{ current_user.email }}"
                               class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                        <span id="profileEmailError" class="text-xs text-red-600 mt-1"></span>
                    </div>
                    <div>
                        <label for="profileFirstName" class="block text-sm font-medium text-gray-700">{{ _('First Name') }}</label>
                        <input id="profileFirstName" type="text" name="first_name" value="{{ current_user.first_name or '' }}"
                               class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                    </div>
                    <div>
                        <label for="profileLastName" class="block text-sm font-medium text-gray-700">{{ _('Last Name') }}</label>
                        <input id="profileLastName" type="text" name="last_name" value="{{ current_user.last_name or '' }}"
                               class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                    </div>
                </div>
                <div class="grid grid-cols-1">
                    <div>
                        <label for="profileLanguage" class="block text-sm font-medium text-gray-700">{{ _('Interface Language') }}</label>
                        <select id="profileLanguage" name="language"
                                class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                            {# Options populated by JS #}
                        </select>
                        <span id="profileLanguageError" class="text-xs text-red-600 mt-1"></span>
                    </div>
                </div>
                <div class="pt-4">
                    <h5 class="text-md font-medium text-gray-800 mb-3">{{ _('Preferences') }}</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="profileDefaultLanguage" class="block text-sm font-medium text-gray-700">{{ _('Default Transcription Language') }}</label>
                            <select id="profileDefaultLanguage" name="default_content_language"
                                    class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                            </select>
                        </div>
                        <div>
                            <label for="profileDefaultModel" class="block text-sm font-medium text-gray-700">{{ _('Default Transcription Model') }}</label>
                            <select id="profileDefaultModel" name="default_transcription_model"
                                    class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                            </select>
                        </div>
                    </div>
                    <div class="mt-4">
                         <label class="flex items-center">
                            <input type="checkbox" id="enable_auto_title_generation" name="enable_auto_title_generation"
                                   class="form-checkbox h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary"
                                   {% if current_user.enable_auto_title_generation %}checked{% endif %}
                                   {% if not user_permissions.allow_auto_title_generation %}disabled{% endif %}/>
                            <span class="ml-2 text-sm text-gray-700">{{ _('Automatically Generate Titles for Transcriptions') }}</span>
                        </label>
                        {% if not user_permissions.allow_auto_title_generation %}
                        <p class="text-xs text-gray-500 ml-6">{{ _('This feature is not enabled for your account role.') }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="text-center pt-4">
                    <button id="saveProfileBtn" type="submit"
                            class="btn-save">
                        {{ _('Save Changes') }} <i class="material-icons text-base ml-2">save</i>
                    </button>
                </div>
            </form>
            <div class="border-t border-gray-200 my-6"></div>
            <button id="changePasswordToggleBtn"
                    class="w-full flex items-center justify-between py-2 text-sm font-medium text-primary hover:text-primary-dark focus:outline-none">
                <span class="flex items-center"><i class="material-icons tiny align-middle mr-1">lock_reset</i>{{ _('Change Password') }}</span>
                <i class="material-icons text-gray-500" id="passwordToggleIconDisplay">expand_more</i>
            </button>
            <div id="changePasswordSection" class="hidden mt-4 space-y-4">
                <form id="changePasswordForm" class="space-y-4">
                    <input type="text"
                           name="username"
                           value="{{ current_user.username }}"
                           autocomplete="username"
                           class="sr-only"
                           tabindex="-1"
                           aria-hidden="true">
                    <div>
                        <label for="currentPassword" class="block text-sm font-medium text-gray-700">{{ _('Current Password') }}</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <input id="currentPassword" type="password" name="current_password"
                                   class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm pr-10" autocomplete="current-password">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <i class="material-icons cursor-pointer text-gray-400 hover:text-gray-600" id="toggleCurrentPassword">visibility</i>
                            </div>
                        </div>
                        <span id="currentPasswordError" class="text-xs text-red-600 mt-1"></span>
                    </div>
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700">{{ _('New Password') }}</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <input id="newPassword" type="password" name="new_password"
                                   class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm pr-10" autocomplete="new-password">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <i class="material-icons cursor-pointer text-gray-400 hover:text-gray-600" id="toggleNewPassword">visibility</i>
                            </div>
                        </div>
                        <span id="newPasswordError" class="text-xs text-red-600 mt-1"></span>
                    </div>
                    <div>
                        <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700">{{ _('Confirm New Password') }}</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <input id="confirmNewPassword" type="password" name="confirm_new_password"
                                   class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm pr-10" autocomplete="new-password">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <i class="material-icons cursor-pointer text-gray-400 hover:text-gray-600" id="toggleConfirmNewPassword">visibility</i>
                            </div>
                        </div>
                        <span id="confirmNewPasswordError" class="text-xs text-red-600 mt-1"></span>
                    </div>
                    <div class="text-center pt-2">
                        <button id="submitPasswordChangeBtn" type="submit"
                                class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-orange-500 hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-400">
                            {{ _('Update Password') }} <i class="material-icons text-base ml-2">lock_reset</i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="flex items-center justify-end p-4 space-x-2 border-t border-gray-200 rounded-b">
            <button type="button" id="profileModalCloseButtonFooter"
                    class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">
                {{ _('Cancel') }}
            </button>
        </div>
    </div>
</div>
{% endif %}
