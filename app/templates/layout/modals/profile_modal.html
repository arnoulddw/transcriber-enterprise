<!-- app/templates/layout/modals/profile_modal.html -->
{# User Settings Modal (Profile Modal) - Implemented with Tailwind and Vanilla JS #}
{% import "layout/components/ui_helpers.html" as ui %}
{% if is_multi_user and current_user.is_authenticated %}
{% call ui.modal_shell('profileModal', labelledby='profileModalTitle', overlay_id='profileModalOverlay', panel_id='profileModalPanel', size='lg', panel_classes='max-h-[90vh] flex flex-col') %}
        <div class="modal-header">
            <h3 id="profileModalTitle" class="modal-title">
                {{ _('User Settings') }}
            </h3>
            <button type="button" id="profileModalCloseButtonHeader"
                    class="ui-btn ui-btn--muted px-2 py-2 rounded-full"
                    aria-label="Close modal">
                <i class="material-icons">close</i>
            </button>
        </div>
        <div class="modal-body space-y-6">
            <form id="profileForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="profileUsername" class="form-label">{{ _('Username') }}</label>
                        <div class="mt-1">
                            <input id="profileUsername" type="text" name="username" value="{{ current_user.username }}"
                                   class="input-control">
                        </div>
                        <span id="profileUsernameError" class="form-error"></span>
                    </div>
                    <div>
                        <label for="profileEmail" class="form-label">{{ _('Email') }}</label>
                        <div class="mt-1">
                            <input id="profileEmail" type="email" name="email" value="{{ current_user.email }}"
                                   class="input-control">
                        </div>
                        <span id="profileEmailError" class="form-error"></span>
                    </div>
                    <div>
                        <label for="profileFirstName" class="form-label">{{ _('First Name') }}</label>
                        <div class="mt-1">
                            <input id="profileFirstName" type="text" name="first_name" value="{{ current_user.first_name or '' }}"
                                   class="input-control">
                        </div>
                    </div>
                    <div>
                        <label for="profileLastName" class="form-label">{{ _('Last Name') }}</label>
                        <div class="mt-1">
                            <input id="profileLastName" type="text" name="last_name" value="{{ current_user.last_name or '' }}"
                                   class="input-control">
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1">
                    <div>
                        <label for="profileLanguage" class="form-label">{{ _('Interface Language') }}</label>
                        <div class="mt-1">
                            <select id="profileLanguage" name="language"
                                    class="input-select">
                                {# Options populated by JS #}
                            </select>
                        </div>
                        <span id="profileLanguageError" class="form-error"></span>
                    </div>
                </div>
                <div class="pt-4">
                    <h5 class="text-md font-medium text-text-strong mb-3">{{ _('Preferences') }}</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="profileDefaultLanguage" class="form-label">{{ _('Default Transcription Language') }}</label>
                            <div class="mt-1">
                                <select id="profileDefaultLanguage" name="default_content_language"
                                        class="input-select">
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="profileDefaultModel" class="form-label">{{ _('Default Transcription Model') }}</label>
                            <div class="mt-1">
                                <select id="profileDefaultModel" name="default_transcription_model"
                                        class="input-select">
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                         <label class="flex items-center">
                            <input type="checkbox" id="enable_auto_title_generation" name="enable_auto_title_generation"
                                   class="form-checkbox h-4 w-4 text-primary border-border-default rounded focus:ring-primary"
                                   {% if current_user.enable_auto_title_generation %}checked{% endif %}
                                   {% if not user_permissions.allow_auto_title_generation %}disabled{% endif %}/>
                            <span class="ml-2 text-sm text-text-strong">{{ _('Automatically Generate Titles for Transcriptions') }}</span>
                        </label>
                        {% if not user_permissions.allow_auto_title_generation %}
                        <p class="text-xs text-text-muted ml-6">{{ _('This feature is not enabled for your account role.') }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="text-center pt-4">
                    {{ ui.button(_('Save Changes'), variant='primary', type='submit', icon='save', icon_position='end', id='saveProfileBtn') }}
                </div>
            </form>
            <div class="surface-divider my-6"></div>
            <button id="changePasswordToggleBtn"
                    class="w-full flex items-center justify-between py-2 text-sm font-medium text-primary hover:text-primary-dark focus:outline-none">
                <span class="flex items-center"><i class="material-icons tiny align-middle mr-1">lock_reset</i>{{ _('Change Password') }}</span>
                <i class="material-icons text-text-muted" id="passwordToggleIconDisplay">expand_more</i>
            </button>
            <div id="changePasswordSection" class="hidden mt-4 space-y-4">
                <form id="changePasswordForm" class="space-y-4">
                    <input type="text"
                           name="username"
                           value="{{ current_user.username }}"
                           autocomplete="username"
                           class="sr-only"
                           tabindex="-1"
                           aria-hidden="true">
                    <div>
                        <label for="currentPassword" class="form-label">{{ _('Current Password') }}</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <input id="currentPassword" type="password" name="current_password"
                                   class="input-control pr-10" autocomplete="current-password">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <i class="material-icons cursor-pointer text-text-muted hover:text-text-strong" id="toggleCurrentPassword">visibility</i>
                            </div>
                        </div>
                        <span id="currentPasswordError" class="form-error"></span>
                    </div>
                    <div>
                        <label for="newPassword" class="form-label">{{ _('New Password') }}</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <input id="newPassword" type="password" name="new_password"
                                   class="input-control pr-10" autocomplete="new-password">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <i class="material-icons cursor-pointer text-text-muted hover:text-text-strong" id="toggleNewPassword">visibility</i>
                            </div>
                        </div>
                        <span id="newPasswordError" class="form-error"></span>
                    </div>
                    <div>
                        <label for="confirmNewPassword" class="form-label">{{ _('Confirm New Password') }}</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <input id="confirmNewPassword" type="password" name="confirm_new_password"
                                   class="input-control pr-10" autocomplete="new-password">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <i class="material-icons cursor-pointer text-text-muted hover:text-text-strong" id="toggleConfirmNewPassword">visibility</i>
                            </div>
                        </div>
                        <span id="confirmNewPasswordError" class="form-error"></span>
                    </div>
                    <div class="text-center pt-2">
                        {{ ui.button(_('Update Password'), variant='primary', type='submit', icon='lock_reset', icon_position='end', id='submitPasswordChangeBtn') }}
                    </div>
                </form>
            </div>
        </div>
        <div class="modal-footer space-x-2">
            {{ ui.button(_('Cancel'), variant='muted', id='profileModalCloseButtonFooter') }}
        </div>
{% endcall %}
{% endif %}
